<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Booking của tôi</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .badge-pending { background-color: #ffc107; color: #212529; }
        .badge-paid { background-color: #17a2b8; color: white; }
        .badge-confirmed { background-color: #28a745; color: white; }
        .badge-cancelled { background-color: #dc3545; color: white; }
    </style>
</head>
<body class="container mt-4">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <a class="navbar-brand" th:href="@{/}">FramgiaTours</a>
    <div class="collapse navbar-collapse">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" th:href="@{/}">Trang chủ</a>
            </li>
            <li class="nav-item" sec:authorize="isAuthenticated()">
                    <span class="navbar-text text-white mr-3">
                        Chào, <span sec:authentication="name"></span>
                    </span>
                <form th:action="@{/logout}" method="POST" class="d-inline">
                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="btn btn-outline-light btn-sm">Đăng xuất</button>
                </form>
            </li>
        </ul>
    </div>
</nav>

<h2>Lịch sử Đặt Tour</h2>

<div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
<div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

<div th:if="${param.payment_status}" class="alert alert-info">
    <span th:if="${param.payment_status[0] == 'success'}">Thanh toán thành công!</span>
    <span th:if="${param.payment_status[0] == 'failed'}">Thanh toán thất bại hoặc bị hủy.</span>
</div>

<div class="card shadow">
    <div class="card-body">
        <table class="table table-hover table-bordered">
            <thead class="thead-dark">
            <tr>
                <th>Mã đơn</th>
                <th>Tour</th>
                <th>Ngày đi</th>
                <th>Số người</th>
                <th>Tổng tiền</th>
                <th>Trạng thái</th>
                <th>Hành động</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="booking : ${bookings}">
                <td th:text="${booking.id}">1</td>
                <td>
                    <strong th:text="${booking.tourName}">Tên Tour</strong><br>
                    <small th:text="${booking.tourLocation}">Địa điểm</small>
                </td>
                <td th:text="${booking.startDate}">2025-12-01</td>
                <td th:text="${booking.numPeople}">2</td>
                <td th:text="${#numbers.formatDecimal(booking.totalPrice, 0, 'COMMA', 0, 'POINT') + ' VND'}">5,000,000 VND</td>
                <td>
                    <span class="badge p-2"
                          th:classappend="${'badge-' + booking.status.toLowerCase()}"
                          th:text="${booking.status}">
                        PENDING
                    </span>
                </td>
                <td>
                    <form th:if="${booking.status == 'PENDING'}"
                          th:action="@{/bookings/{id}/payment(id=${booking.id})}"
                          method="POST" class="d-inline-block mr-2">

                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <button type="submit" class="btn btn-success btn-sm">Thanh toán (VNPAY)</button>
                    </form>

                    <form th:if="${booking.status == 'PENDING' or booking.status == 'PAID'}"
                          th:action="@{/bookings/{id}/cancel(id=${booking.id})}"
                          method="POST" class="d-inline-block"
                          onsubmit="return confirm('Bạn chắc chắn muốn hủy booking này?');">

                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                        <button type="submit" class="btn btn-danger btn-sm">Hủy</button>
                    </form>
                </td>
            </tr>

            <tr th:if="${#lists.isEmpty(bookings)}">
                <td colspan="7" class="text-center">Bạn chưa đặt tour nào.</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="mt-3">
    <a href="/" class="btn btn-secondary">Quay lại trang chủ</a>
</div>

</body>
</html>